!function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var i={};t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=128)}({1:function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});t.CubeError=function e(t,i){n(this,e),this.code=t,this.message=i}},128:function(e,t,i){"use strict";var n=i(85),r=i(49);!function(e){e.CubeLiveServiceWorker=n.LiveServiceWorker,e.CubeLiveListener=r.LiveListener}(window)},129:function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.LiveService=function(e){function t(){return n(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),a(t,[{key:"startRecord",value:function(e,t,i,n){}},{key:"stopRecord",value:function(){}},{key:"getLiveInfo",value:function(e){}},{key:"startWatch",value:function(e){}},{key:"stopWatch",value:function(e){}},{key:"getMediaDeviceList",value:function(){}}]),t}(CubeService)},130:function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.LiveAgent=function(){function e(t,i){n(this,e),this.liveCore=t,this.liveInfo=i,this.live=null,this.channel=null}return r(e,[{key:"start",value:function(e){this.live=new this.liveCore;var t=this.liveInfo.mediaDevice;if(t){if("string"!=typeof t.video){var i=this.live.listDevices();t.video=i.video[0]}if("string"!=typeof t.audio){var n=this.live.listDevices();t.audio=n.audio[0]}}else{var r=this.live.listDevices();t={video:r.video[0],audio:r.audio[0]}}this.channel=this.live.startLiveChannel(t.video,t.audio,this.liveInfo.server.host,this.liveInfo.server.port,this.liveInfo.groupId,this.liveInfo.server.streamPort,function(t){e(t)})}},{key:"stop",value:function(){this.channel.stop(),this.live.destroy()}}]),e}()},131:function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.LiveInfo=function(){function e(t,i,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Date.now();n(this,e),this.name=t,this.members=o,this.master=r,this.startTime=a,this.groupId=i,this.server=null,this.mediaDevice=null,this.type=null,this.watchUrl=null}return r(e,[{key:"getName",value:function(){return this.name}},{key:"getMembers",value:function(){return this.members}},{key:"getMaster",value:function(){return this.master}},{key:"getStartTime",value:function(){return this.startTime}},{key:"getGroupId",value:function(){return this.groupId}}]),e}()},132:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Action={Live:"live",LiveAck:"live-ack",StopLive:"stop-live",StopLiveAck:"stop-live-ack",Watch:"watch",WatchAck:"watch-ack",StopWatch:"stop-watch",StopWatchAck:"stop-watch-ack",GetList:"/live/get_list/",GetInfoBatch:"/live/get_info_batch/"}},49:function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();t.LiveListener=function(e){function t(){return n(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),a(t,[{key:"onLiveStarted",value:function(e,t){}},{key:"onLiveStopped",value:function(e,t){}},{key:"onLookerJoined",value:function(e,t){}},{key:"onLookerQuit",value:function(e,t){}},{key:"onFailed",value:function(e){}}]),t}(CubeListener)},85:function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.LiveServiceWorker=void 0;var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=i(129),c=i(49),u=i(132),l=i(131),v=i(130),f=i(1);t.LiveServiceWorker=function(e){function t(e,i,o){n(this,t);var a=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,c.LiveListener,window.CELLET.Live));return a.liveCore=i,a.liveMap=new HashMap,a.liveAgent=null,a.viewDom=o,a.resourcePath=e.resourcePath+"/live/",a}return o(t,e),a(t,[{key:"setResourcePath",value:function(e){this.resourcePath=e+"/"}},{key:"startRecord",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.liveMap.containsKey(e))return!1;n="number"==typeof n?n:0;var r={groupId:e,liveName:t,type:n};return!!this.engine.connect.send(CELLET.Live,u.Action.Live,r)}},{key:"stopRecord",value:function(){for(var e=this.viewDom.childNodes,t=0;t<e.length;t++)this.viewDom.removeChild(e[t]);if(this.liveAgent instanceof v.LiveAgent){var i=this.liveAgent.liveInfo;this.liveAgent.stop(),this.liveAgent=null,this.liveMap.remove(i.groupId);var n={groupId:i.groupId};return this.engine.connect.send(CELLET.Live,u.Action.StopLive,n)}return!1}},{key:"getLiveInfo",value:function(e){return this.liveMap.get(e)}},{key:"startWatch",value:function(e){return!!(this.liveMap.get(e)instanceof l.LiveInfo&&this.engine.connect.send(CELLET.Live,u.Action.Watch,param))}},{key:"stopWatch",value:function(e){if(this.liveMap.get(e)instanceof l.LiveInfo){for(var t=this.viewDom.childNodes,i=0;i<t.length;i++)this.viewDom.removeChild(t[i]);var n={groupId:e};return this.engine.connect.send(CELLET.Live,u.Action.StopWatch,n)}return!1}},{key:"getMediaDeviceList",value:function(){var e=new this.liveCore,t=e.listDevices();return e.destroy(),t}},{key:"onRegisterStateChanged",value:function(e){var t=this;if(this.engine.registered){var i=(this.utils.isSecure?"https":"http")+"://"+_CUBE_DOMAIN+":"+_CUBE_PORT,n=new CubeRequest(i);n.send(u.Action.GetList,{token:this.engine.accToken,tag:window.nucleus.tag},function(e,i){if(e)nucleus.getLogger().w("CubeLiveService#GetList","Get live list failed!");else if(200===i.state.code){var r=i.data.list;r&&r.length>0&&n.send(u.Action.GetInfoBatch,{token:t.engine.accToken,tag:window.nucleus.tag,groupIds:r},function(e,i){if(e)nucleus.getLogger().w("CubeLiveService#GetLiveInfoList","Get live info list failed!");else if(200===i.state.code){var n=i.data.list,r=!0,o=!1,a=void 0;try{for(var s,c=n[Symbol.iterator]();!(r=(s=c.next()).done);r=!0){var u=s.value,v=new l.LiveInfo(u.liveName,u.groupId,u.master,u.members,Date.now());v.type=u.type,v.watchUrl=u.url,v.server=u.server,t.liveMap.put(u.groupId,v),t.delegate.onLiveStarted(u.groupId,u.master)}}catch(e){o=!0,a=e}finally{try{!r&&c.return&&c.return()}finally{if(o)throw a}}}})}})}}},{key:"_processLive",value:function(e){var t=e.getParamAsString("data"),i=t.groupId,n=new l.LiveInfo(t.liveName,i,t.master,[],t.startTime);n.server=t.server,n.type=t.type,n.watchUrl=t.url,this.liveMap.put(i,n),this.delegate.onLiveStarted(i,t.master)}},{key:"_processLiveAck",value:function(e){var t=this,i=e.getParamAsString("state");if(200===i.code){var n=e.getParamAsString("data"),r=n.groupId;if(this.liveAgent instanceof v.LiveAgent&&this.liveAgent.liveInfo.groupId===r){var o=this.liveAgent.liveInfo;o.server=n.server,o.watchUrl=n.url,this.liveAgent.start(function(e){if(e)return t.stopRecord(),void t.delegate.onFailed(new f.CubeError(CubeStateCode.LiveStartFailed,"Live start failed."));t.delegate.onLiveStarted(r,t.engine.accName)}),this._loadView(o)}}else{var a=this.liveMap.keySet(),s=!0,c=!1,u=void 0;try{for(var l,p=a[Symbol.iterator]();!(s=(l=p.next()).done);s=!0){var h=l.value;if(this.liveMap.get(h).master===this.engine.accName){this.liveMap.remove(h);break}}}catch(e){c=!0,u=e}finally{try{!s&&p.return&&p.return()}finally{if(c)throw u}}this.delegate.onFailed(new f.CubeError(i.code,i.desc))}}},{key:"_processStopLive",value:function(e){var t=e.getParamAsString("data");if(this.liveMap.get(t.groupId)instanceof l.LiveInfo){for(var i=this.viewDom.childNodes,n=0;n<i.length;n++)this.viewDom.removeChild(i[n]);this.liveMap.remove(t.groupId),this.delegate.onLiveStopped(t.groupId,t.master)}}},{key:"_processStopLiveAck",value:function(e){var t=e.getParamAsString("state"),i=e.getParamAsString("data");200===t.code?this.delegate.onLiveStopped(i.groupId,this.engine.accName):this.delegate.onFailed(new f.CubeError(t.code,t.desc),i.param.groupId)}},{key:"_processWatch",value:function(e){var t=e.getParamAsString("data"),i=this.liveMap.get(t.groupId);i instanceof l.LiveInfo&&(i.members.concat(t.watchers),this.delegate.onLookerJoined(t.groupId,t.watchers))}},{key:"_processWatchAck",value:function(e){var t=e.getParamAsString("state"),i=e.getParamAsString("data");if(200===t.code){var n=this.liveMap.get(i.groupId);this._loadView(n),this.delegate.onLookerJoined(i.groupId,[this.engine.accName])}else t.code===window.CubeStateCode.LiveNotExist?(this.liveMap.remove(i.groupId),this.delegate.onFailed(new f.CubeError(window.CubeStateCode.LiveNotExist,"Watch live failed, live channel not exist."),i.param.groupId)):this.delegate.onFailed(new f.CubeError(t.code,t.desc),i.param.groupId)}},{key:"_processStopWatch",value:function(e){var t=e.getParamAsString("data");this.liveMap.get(t.groupId)instanceof l.LiveInfo&&this.delegate.onLookerQuit(t.groupId,t.watchers)}},{key:"_processStopWatchAck",value:function(e){var t=e.getParamAsString("state"),i=e.getParamAsString("data");200===t.code?this.delegate.onLookerQuit(i.groupId,[this.engine.accName]):this.delegate.onFailed(new f.CubeError(t.code,t.desc),i.param.groupId)}},{key:"_loadView",value:function(e){var t="http://"+e.server.host+":"+e.server.port+"/live/live.m3u8?n="+e.groupId+"&t="+Date.now(),i=document.createElement("iframe");i.style.width="100%",i.style.height="100%",i.style.border="none",i.style.padding="0",i.style.margin="0",i.src=this.resourcePath+"player.html?m3u8="+encodeURIComponent(t),this.viewDom.appendChild(i)}},{key:"onDialogue",value:function(e,t){switch(e){case u.Action.Live:this._processLive(t);break;case u.Action.LiveAck:this._processLiveAck(t);break;case u.Action.StopLive:this._processStopLive(t);break;case u.Action.StopLiveAck:this._processStopLiveAck(t);break;case u.Action.Watch:this._processWatch(t);break;case u.Action.WatchAck:this._processWatchAck(t);break;case u.Action.StopWatch:this._processStopWatch(t);break;case u.Action.StopWatchAck:this._processStopWatchAck(t)}}}]),t}(s.LiveService)}});
//# sourceMappingURL=cube-live.js.map