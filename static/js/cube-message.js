!function(e){function t(s){if(n[s])return n[s].exports;var i=n[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=133)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageType={Text:"text",Custom:"custom",File:"file",Image:"image",Voice:"voice",Video:"video",Whiteboard:"whiteboard",WhiteboardClip:"whiteboardclip",Card:"card",History:"history",Location:"location",RichContent:"richcontent",Reply:"reply",Receipt:"receipt",UnKnown:"unKnown"}},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});t.CubeError=function e(t,n){s(this,e),this.code=t,this.message=n}},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEntity=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=n(69),a=(n(0),n(21));t.MessageEntity=function(){function e(t){s(this,e),this.sn=e.generateSerialNumber(),this.type=t,this.customData=_cube_timestamp++,this.status=r.MessageStatus.CREATE,this.direction=a.MessageDirection.None,this.receipted=!1,this.receiver=null,this.sender=null,this.group=null,this.sendTime=0,this.receiveTime=0,this.timestamp=0,this.pulled=!1,this.traceless=!1,this.fromDevice=null,this.receivedDevices=null,this.receiptedDevices=null,this.anonymous=!1,this.sync=0,this.tos=null,this.header=new HashMap,this.device=cube.getDeviceInfo()}return i(e,[{key:"setHeader",value:function(e,t){this.header.put(e,t)}},{key:"getHeader",value:function(e){return this.header.get(e)}},{key:"getSN",value:function(){return this.sn}},{key:"getType",value:function(){return this.type}},{key:"getReceiver",value:function(){return this.receiver}},{key:"getSender",value:function(){return this.sender}},{key:"getSendTime",value:function(){return this.sendTime}},{key:"getReceiveTime",value:function(){return this.receiveTime}},{key:"getTimestamp",value:function(){return this.timestamp}},{key:"hasPulled",value:function(){return this.pulled}},{key:"isGroupMessage",value:function(){return null!=this.group}},{key:"setTraceless",value:function(e){this.traceless=e}},{key:"getTraceless",value:function(){return this.traceless}},{key:"getStatus",value:function(){return this.status}},{key:"getFromDevice",value:function(){return this.fromDevice}},{key:"getReceivedDevices",value:function(){return this.receivedDevices}},{key:"getDirection",value:function(){return this.direction}},{key:"isReceipted",value:function(){return this.receipted}},{key:"setAnonymous",value:function(e){this.anonymous=e}},{key:"setDisplayName",value:function(e){this.sender.displayName=e}},{key:"setSyncType",value:function(e){this.sync=e}},{key:"setOnlyReceivers",value:function(e){this.tos=e}},{key:"toJSON",value:function(){for(var e={},t=this.header.keySet(),n=0;n<t.length;++n){var s=t[n],i=this.header.get(s);null!=i&&(e[s]=i)}var r={sn:this.sn,type:this.type,from:this.sender,to:this.receiver,header:e,sync:this.sync,traceless:this.traceless,time:{send:this.sendTime,receive:this.receiveTime,timestamp:this.timestamp},anonymous:this.anonymous};return this.tos&&(r.tos=this.tos),r}}],[{key:"generateSerialNumber",value:function(){(null==this.gCounts||this.gCounts>=99)&&(this.gCounts=0),++this.gCounts;var e=[],t=new Date,n=t.getDate(),s=t.getHours(),i=t.getMinutes(),r=t.getSeconds();e.push(window.cube._cube_token),e.push(n>9?n:"0"+n),e.push(s>9?s:"0"+s),e.push(i>9?i:"0"+i),e.push(r>9?r:"0"+r),e.push(this.gCounts>9?this.gCounts:"0"+this.gCounts);var a=e.join("");return e.splice(0,e.length),e=null,a=Number(a)}}]),e}()},,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.StateCode={Ok:200,Accepted:202,NoContent:204,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UnsupportedMediaType:415,ExpectationFailed:417,TooManyRequests:429,RequestSendFailed:477,TemporarilyUnavailable:480,BusyHere:486,RequestTerminated:487,ServerInternalError:500,GatewayTimeout:504,GetLicenseFail:500,BusyEverywhere:600,Declined:603,DoesNotExistAnywhere:604,ConnectionFailed:700,SignalingStartError:701,TransportError:702,ICEConnectionFailed:703,ParamError:704,CreateSessionDescriptionFailed:705,SetSessionDescriptionFailed:706,RTCInitializeFailed:707,DuplicationException:710,WorkerStateException:711,CallTimeout:712,NotFoundConference:713,UnexpectedCanceled:714,IncorrectState:801,NetworkNotReachable:809,ContentTooLong:810,BlockOversize:811,FormatError:812,ContentError:813,OutOfLimit:814,NoReceiver:815,RecallTimeout:816,NullMessage:817,MessageExpire:818,LostAssets:820,UploadFailed:823,ProcessFailed:825,LoadFileFailed:828,AnswerByOther:900,CancelByOther:901,Unknown:0,InitFailed:1001,LoadLicenseFailed:1002,LicenseOutDate:1003,UnRegister:1004,LicenseServerError:1005,LicenseUpdateError:1006,ReLoginTimeout:1007,RecallError:1100,ForwardError:1101,VoiceClipTooShort:1102,VideoClipTooShort:1103,MessageNotExist:1104,MessageTimeout:1105,ReceiptError:1106,QueryNOData:1107,DispatchFailed:1108,OutDateMessage:1109,FileMessageDownloadFailed:1110,FileMessageDownloadTimeout:1111,NotFoundReceiptMessage:1114,SetTopError:1117,SyncMessageTimeout:1118,FileProgressFailed:1119,FileNotExistOnServer:1200,FileUploadError:1201,FileDataFormatError:1202,RenamedFailed:1203,CubeStateLoadFileFailed:1204,DeleteFailed:1205,MkdirFailed:1206,FileUsedByOther:1207,GroupAddMasterFailed:1300,GroupRemoveMasterFailed:1301,GroupDestory:1302,GroupNotExist:1303,AlreadyInCalling:1400,CallerDoesNotExist:1401,ConferenceExist:1500,OverMaxNumber:1501,ConferenceRejectByOther:1502,ConferenceJoinFromOther:1503,ConferenceJoinFailed:1506,ConferenceRejectFailed:1507,ConferenceClosed:1508,ConferenceSipInviteFailed:1551,ConferenceTimeout:1552,ConferenceAccessDenied:1598,ConferenceNotStatus:1599,ExportWhiteboardFailed:1600,ImportWhiteboardFailed:1601,WhiteboardNotExist:1602,WhiteboardUploadFailed:1603,WhiteboardConvertFailed:1604,CameraOpenFailed:1700,ActiveAudioSessionFailed:1701,MicphoneOpenFailed:1702,VideoConvertFailed:1703,AudioRecorderInitialFailed:1704,AudioRecorderPrepareFailed:1705,AudioPlayDecodeFailed:1706,NotSupportUserMedia:1707,LiveStartFailed:1800,LiveNotExist:1801,NotHavePermission:1e4}},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.FileMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0),l=n(68),c=n(1),f=n(70),p=n(140),d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(p);t.FileMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.File));return n.file=null,n.domId=null,n.formFile=null,n.accept="",n.customPostMethod=null,n.customPostParam={},n.pause=!1,n.receiver={name:e},n.fileStatus=l.FileMessageStatus.None,n.key=null,n.server=new CubeRequest(cube.utils.isSecure?"https":"http://"+_CUBE_DOMAIN+":"+_CUBE_PORT),n}return r(t,e),a(t,[{key:"getFileStatus",value:function(){return this.fileStatus}},{key:"getFile",value:function(){return this.file}},{key:"chooseFile",value:function(e){var t=this,n=this._buildForm();n.onchange=function(){if(null!=n.files&&n.files.length>0){var s=n.files[0];t.formFile=s,t.calculate(s,function(n){t.file={modified:0,name:s.name,size:s.size,md5:n},null!=e&&e(s,n)})}},n.click()}},{key:"setFileByFileList",value:function(e){var t=this;if(null!=e&&e.length>0){this._buildForm().files=e;var n=e[0];return t.calculate(n,function(e){t.file={modified:0,name:n.name,size:n.size,md5:e}}),!0}return!1}},{key:"setFormFile",value:function(e,t){var n=this;return window.FormData&&(this.formFile=e,n.calculate(e,function(s){return n.file={modified:0,name:e.name,size:e.size,md5:s},n.formFile.md5=s,null!=t&&t(e),!0})),!1}},{key:"setMd5",value:function(e){this.file.md5=e}},{key:"calculate",value:function(e,t){function n(){var t=o*r,n=t+r>=e.size?e.size:t+r;s.readAsBinaryString(i.call(e,t,n))}var s=new FileReader,i=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice,r=2097152,a=Math.ceil(e.size/r),o=0,u=new d.default;s.onload=function(e){u.appendBinary(e.target.result),o++,o<a?n():t(u.end())},n()}},{key:"_buildForm",value:function(){this.domId="_cube_file_msg_"+this.customData,this.customPostParam={data:{sn:this.sn,cube:this.receiver.name,file:null},action:this._getServerAction(f.FileAction.StartUpload)};var e=this._getFileFormInfo(),t=e.data,n=document.createElement("div");return n.id=this.domId,n.style.display="none",n.innerHTML='<form id="_form'+this.domId+'" method="POST" enctype="multipart/form-data" action="'+e.action+'" target="_frame'+this.domId+'"><input type="hidden" name="size" value=""/><input type="hidden" name="md5" value=""/><input type="hidden" name="cube" value="'+t.cube+'"/><input type="hidden" name="sn" value="'+t.sn+'"/><input type="file" name="file" accept="'+this.accept+'"/></form><iframe name="_frame'+this.domId+'"></iframe>',document.body.appendChild(n),n.getElementsByTagName("input")[4]}},{key:"_cancel",value:function(){if(this._canceled=!0,null!=this.domId){var e=document.getElementById(this.domId);if(null!=e)return document.body.removeChild(e),!0}return!1}},{key:"_customPostMethod",value:function(){if(null!=this.customPostMethod&&"function"==typeof this.customPostMethod)this.customPostMethod(this._getFileFormInfo());else if(null!=this.formFile){var e=new CubeRequest(""),t=this._getFileFormInfo();delete t.data.file,e.sendFile(t.action,{name:"file",value:this.formFile},t.data,function(e){if(e)throw e})}else{var n=this._getFileFormInfo().data,s=document.getElementById("_form"+this.domId);null!=s?(s.action=this._getFileFormInfo().action,s.getElementsByTagName("input")[0].value=n.size,s.getElementsByTagName("input")[1].value=n.md5,s.submit()):nucleus.getLogger().e("FileMessage#_postData","Send File Message Error, No files selected")}}},{key:"_getServerAction",value:function(e){var t=window.location.protocol;return 0!=t.indexOf("http")&&(t="http:"),t+"//"+_CUBE_DOMAIN+":"+_CUBE_PORT+e}},{key:"_getFileFormInfo",value:function(){return this.customPostParam}},{key:"_getFileRichFormInfo",value:function(e){return{data:{receiver:window.cube.accName+","+e.file.md5,file:null},action:this._getServerAction(f.FileAction.RichMessageUpload)}}},{key:"_notifyAck",value:function(e){var t=!1,n=-1,s=Date.now(),i=0,r=0,a=0,o=this,u=function u(){if(!o._canceled&&!o.pause){var l=Date.now()-s;if(!t&&l<6e4&&setTimeout(function(){u()},5e3),t)if(null!=o.domId){var p=document.getElementById(o.domId);null!=p&&document.body.removeChild(p)}else null!=o.formFile&&(o.formFile=null);else{if(l>=6e4){if(n>0){if(e(new c.CubeError(n,"Upload file timeout")),null!=o.domId){var d=document.getElementById(o.domId);null!=d&&document.body.removeChild(d)}else null!=o.formFile&&(o.formFile=null);return}s=Date.now(),setTimeout(function(){u()},5e3)}var g={sn:o.sn,cube:o.receiver.name,fileName:o.file.name};o.file.key&&(g.key=o.file.key),o.server.sendFile(f.FileAction.GetProgress,{},g,function(s,u){if(200==u.state.code){var l=u.data;i!==parseInt(l.current)?(a=0,i=parseInt(l.current)):a++,r=parseInt(l.total),i===r?(e(!1,i,r),t=!0):a>10?(e(new c.CubeError(CubeStateCode.RequestTimeout,"Upload file timeout")),n=CubeStateCode.RequestTimeout,o._cancel()):e(!1,i,r)}else e(new c.CubeError(u.state.code,u.state.dec)),n=u.state.code,o._cancel()})}}};setTimeout(function(){u()},2e3)}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=e.file,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.FileAction={Uploader:"/v3/file/upload",FileList:"/v3/file/list",Mkdir:"/v3/file/mkdir",DeleteFiles:"/v3/file/delete",CopyFile:"/v3/file/copy",MoveFile:"/v3/file/move",RenameFile:"/v3/file/rename",FileInfo:"/v3/file/info",searchFile:"/v3/file/search",CancelFile:"/v3/file/cancel",ResumeFile:"/v3/file/resume",PauseFile:"/v3/file/pause",CreateUploadFile:"/v3/file/createUpload",ProgressFile:"/v3/file/progress"}},,,,,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.TextMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.TextMessage=function(e){function t(e,n){s(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Text));return r.receiver={name:e},r.content=null,void 0!==n&&(r.content=n),r}return r(t,e),a(t,[{key:"getContent",value:function(){return this.content}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.content=this.content,e.contentKey=this.contentKey,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name,e.content);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device?e.device:"",n.receivedDevices=e.pulledDevices?e.pulledDevices:"",n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ImageMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(6),u=n(0),l=n(2);t.ImageMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type=u.MessageType.Image,n.accept=".jpeg, .jpg, .png, .bmp, .gif",n}return r(t,e),a(t,[{key:"setFileByFileList",value:function(e){if(null!=e&&e.length>0){var t=e[0],n=t.name.split("."),s=n[n.length-1].toLowerCase();if("jpeg"==s||"jpg"==s||"png"==s||"bmp"==s||"gif"==s){return this._buildForm().files=e,this.file={modified:0,name:t.name,size:t.size},!0}}return!1}},{key:"getFile",value:function(){return this.file}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.FileMessage)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageDirection={None:"none",Received:"received",Sent:"sent"}},,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.CardMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=(n(6),n(0)),u=n(2);t.CardMessage=function(e){function t(e,n,r,a,u){s(this,t);var l=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return l.type=o.MessageType.Card,l.receiver={name:e},l.title=n,l.icon=r,l.content=a,l.cardContents=[],l.traceless=!1,l.pulled=!1,l.secret=!1,l.device=cube.deviceInfo,l}return r(t,e),a(t,[{key:"setCardContents",value:function(e){this.cardContents=e}},{key:"setCardContent",value:function(e,t,n,s){this.cardContents.push({name:e,icon:t,url:n,desc:s})}},{key:"getCardContent",value:function(){return this.cardContents[0]}},{key:"toJSON",value:function(){var e=u.MessageEntity.prototype.toJSON.call(this);return e.content=this.content,e.cardContents=this.cardContents,e.title=this.title,e.icon=this.icon,e.traceless=this.traceless,e.pulled=this.pulled,e.secret=this.secret,e.group=this.group,e.device=this.device,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name,e.title,e.icon,e.content,e.desc);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n.cardContents=e.cardContent?[e.cardContent]:e.cardContents,n}}]),t}(u.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.CustomMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.CustomMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Custom));return n.receiver={name:e},n.body=null,n.expires=0,n}return r(t,e),a(t,[{key:"setBody",value:function(e){this.body=e}},{key:"getBody",value:function(){return this.body}},{key:"setExpires",value:function(e){this.expires=e}},{key:"getExpires",value:function(){return this.expires}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.expires=this.expires,null!=this.body&&(e.body=this.body),e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);if(n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,void 0!==e.header)for(var s in e.header)n.setHeader(s,e.header[s]);return void 0!==e.body&&n.setBody(e.body),n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiptMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.ReceiptMessage=function(e){function t(e,n,r){s(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Receipt));return a.receiver={name:e},a.sender=n,a.traceless=!0,null!=r&&(a.sn=r),null!=n&&(a.sender=n),a}return r(t,e),a(t,[{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.sns=this.sns,e}}],[{key:"parse",value:function(e){var n=new t;return n.receiver={name:e.to.name,displayName:e.to.displayName},n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device?e.device:"",n.receivedDevices=e.pulledDevices?e.pulledDevices:"",n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ReplyMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.ReplyMessage=function(e){function t(e,n,r){s(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Reply));return a.receiver={name:e},null!=n&&(n.sn=a.sn),a.reply=n,a.source=r,a}return r(t,e),a(t,[{key:"setSource",value:function(e){this.source={type:e.type,content:e.content,from:e.sender,sn:e.sn,to:e.receiver,time:{receive:e.receiveTime,send:e.sendTime,timestamp:e.timestamp}},this.source=Object.assign(this.source,e),null!=e.tos&&(this.source.tos=e.tos),null!=e.group&&(this.source.group=e.group.name),e.type==u.MessageType.Reply&&(this.source.content=e.reply.content)}},{key:"toJSON",value:function(){null!=this.reply&&(this.reply.sender=this.sender);var e=o.MessageEntity.prototype.toJSON.call(this);return e.source=this.source instanceof o.MessageEntity?this.source.toJSON():this.source,e.reply=this.reply instanceof o.MessageEntity?this.reply.toJSON():this.reply,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name,e.reply,e.source);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),null!=n.reply&&(n.reply.sn=e.sn,n.reply.from=e.from,n.reply.time=e.time,n.reply.sendTime=e.time.send,n.reply.receiveTime=e.time.receive,n.reply.timestamp=e.time.timestamp),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device?e.device:"",n.receivedDevices=e.pulledDevices?e.pulledDevices:"",n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.WhiteboardMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Whiteboard));return n.receiver={name:e},n.content=null,n.domId=null,n.file=null,n.finish=null,n.completeCb=null,n}return r(t,e),a(t,[{key:"fillContent",value:function(e){this.content=JSON.stringify(e),this.file={modified:0,name:Date.now()+".cwb",size:this.content.length}}},{key:"getFile",value:function(){return this.file}},{key:"_buildForm",value:function(){this.domId="_cube_wb_msg_"+this.customData;var e=document.createElement("div");return e.id=this.domId,e.style.display="none",e.innerHTML='<form id="_form'+this.domId+'" method="POST" enctype="multipart/form-data" action="'+this._getServerAction()+'" target="_frame'+this.domId+'"><input type="hidden" name="filename" value="'+this.file.name+'"/><input type="hidden" name="receiver" value="'+this.receiver.name+'"/><input type="hidden" name="sender" value="'+this.sender.name+'"/><input type="hidden" name="sendTime" value="'+this.sendTime+'"/><input type="hidden" name="content" value=\''+this.content+"'/></form><iframe name=\"_frame"+this.domId+'"></iframe>',document.body.appendChild(e),e}},{key:"_postData",value:function(){var e=this._buildForm(),t=e.getElementsByTagName("iframe")[0],n=this;t.onload=function(){setTimeout(function(){n.finish=!0,null!=n.completeCb&&n.completeCb(!1,n.content.length,n.content.length),n._clear()},1e3)};var s=document.getElementById("_form"+this.domId);null!=s?s.submit():nucleus.getLogger().e("CubeWhiteboardMessage#_postData","Send content error")}},{key:"_notifyAck",value:function(e){this.finish?e(!1,this.content.length,this.content.length):this.completeCb=complete}},{key:"_fetchData",value:function(e,t){var n=cube.utils.isSecure?"https":"http",s=n+"://"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/message/read/cwb/?receiver="+this.receiver.name+"&sn="+this.sn,i=this;Ajax.newRequest(s).method("GET").send(function(n){200==n.getStatus()?(i.content=n.getData().toString(),e.call(null,i)):t.call(null,i,n.getStatus())})}},{key:"_getServerAction",value:function(){var e=window.location.protocol;return 0!=e.indexOf("http")&&(e="http:"),e+"//"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/message/submit/"}},{key:"_clear",value:function(){if(this.completeCb=null,null!=this.domId){var e=document.getElementById(this.domId);if(null!=e)return document.body.removeChild(e),!0}return!1}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.VideoMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(6),u=n(0),l=n(2);t.VideoMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type=u.MessageType.Video,n}return r(t,e),a(t,[{key:"getFile",value:function(){return this.file}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.FileMessage)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.VoiceMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(6),u=n(0),l=n(2);t.VoiceMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type=u.MessageType.Voice,n.stopCallback=null,n}return r(t,e),a(t,[{key:"getFile",value:function(){return this.file}},{key:"startRecord",value:function(e){var t=this;cube.utils.getUserMedia(!1,!0,function(n,s){if(n)e(n);else{t.recorder=new MediaRecorder(s),t.audioTrack=s.getAudioTracks()[0];var i=[],r=0;t.recorder.ondataavailable=function(e){i.push(e.data)},t.recorder.onstop=function(e){var n=(Date.now()-r)/1e3;if(!t.canceledRecord){var s=new File(i,"cube_clip_voice"+Date.now()+".ogg",{type:"audio/ogg; codecs=opus"});t.setFormFile(s,function(){t.file.duration=Math.round(n),"function"==typeof t.stopCallback&&t.stopCallback(s)})}i=[],t.canceledRecord=!1},t.recorder.start(),r=Date.now(),e()}})}},{key:"stopRecord",value:function(e){null!=this.recorder&&null!=this.audioTrack&&(this.stopCallback=e,this.recorder.stop(),this.audioTrack.stop(),this.recorder=null,this.audioTrack=null)}},{key:"cancelRecord",value:function(){this.canceledRecord=!0,this.stopRecord()}},{key:"getVoiceFile",value:function(){return this.formFile}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.FileMessage)},,,function(e,t,n){"use strict";var s,i,r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(a){if("object"===r(t))e.exports=a();else{s=a,void 0!==(i="function"==typeof s?s.call(t,n,t,e):s)&&(e.exports=i)}}(function(e){function t(e,t){var n=e[0],s=e[1],i=e[2],r=e[3];n+=(s&i|~s&r)+t[0]-680876936|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[1]-389564586|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[2]+606105819|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[3]-1044525330|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[4]-176418897|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[5]+1200080426|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[6]-1473231341|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[7]-45705983|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[8]+1770035416|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[9]-1958414417|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[10]-42063|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[11]-1990404162|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[12]+1804603682|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[13]-40341101|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[14]-1502002290|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[15]+1236535329|0,s=(s<<22|s>>>10)+i|0,n+=(s&r|i&~r)+t[1]-165796510|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[6]-1069501632|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[11]+643717713|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[0]-373897302|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[5]-701558691|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[10]+38016083|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[15]-660478335|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[4]-405537848|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[9]+568446438|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[14]-1019803690|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[3]-187363961|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[8]+1163531501|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[13]-1444681467|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[2]-51403784|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[7]+1735328473|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[12]-1926607734|0,s=(s<<20|s>>>12)+i|0,n+=(s^i^r)+t[5]-378558|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[8]-2022574463|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[11]+1839030562|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[14]-35309556|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[1]-1530992060|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[4]+1272893353|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[7]-155497632|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[10]-1094730640|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[13]+681279174|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[0]-358537222|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[3]-722521979|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[6]+76029189|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[9]-640364487|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[12]-421815835|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[15]+530742520|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[2]-995338651|0,s=(s<<23|s>>>9)+i|0,n+=(i^(s|~r))+t[0]-198630844|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[7]+1126891415|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[14]-1416354905|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[5]-57434055|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[12]+1700485571|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[3]-1894986606|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[10]-1051523|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[1]-2054922799|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[8]+1873313359|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[15]-30611744|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[6]-1560198380|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[13]+1309151649|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[4]-145523070|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[11]-1120210379|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[2]+718787259|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[9]-343485551|0,s=(s<<21|s>>>11)+i|0,e[0]=n+e[0]|0,e[1]=s+e[1]|0,e[2]=i+e[2]|0,e[3]=r+e[3]|0}function n(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function s(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function i(e){var s,i,r,a,o,u,l=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(s=64;s<=l;s+=64)t(c,n(e.substring(s-64,s)));for(e=e.substring(s-64),i=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=0;s<i;s+=1)r[s>>2]|=e.charCodeAt(s)<<(s%4<<3);if(r[s>>2]|=128<<(s%4<<3),s>55)for(t(c,r),s=0;s<16;s+=1)r[s]=0;return a=8*l,a=a.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(a[2],16),u=parseInt(a[1],16)||0,r[14]=o,r[15]=u,t(c,r),c}function r(e){var n,i,r,a,o,u,l=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(n=64;n<=l;n+=64)t(c,s(e.subarray(n-64,n)));for(e=n-64<l?e.subarray(n-64):new Uint8Array(0),i=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=0;n<i;n+=1)r[n>>2]|=e[n]<<(n%4<<3);if(r[n>>2]|=128<<(n%4<<3),n>55)for(t(c,r),n=0;n<16;n+=1)r[n]=0;return a=8*l,a=a.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(a[2],16),u=parseInt(a[1],16)||0,r[14]=o,r[15]=u,t(c,r),c}function a(e){var t,n="";for(t=0;t<4;t+=1)n+=g[e>>8*t+4&15]+g[e>>8*t&15];return n}function o(e){var t;for(t=0;t<e.length;t+=1)e[t]=a(e[t]);return e.join("")}function u(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function l(e,t){var n,s=e.length,i=new ArrayBuffer(s),r=new Uint8Array(i);for(n=0;n<s;n+=1)r[n]=e.charCodeAt(n);return t?r:i}function c(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function f(e,t,n){var s=new Uint8Array(e.byteLength+t.byteLength);return s.set(new Uint8Array(e)),s.set(new Uint8Array(t),e.byteLength),n?s:s.buffer}function p(e){var t,n=[],s=e.length;for(t=0;t<s-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function d(){this.reset()}var g=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return"5d41402abc4b2a76b9719d911017c592"!==o(i("hello"))&&function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function t(e,t){return e=0|e||0,e<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,s){var i,r,a,o,u=this.byteLength,l=t(n,u),c=u;return s!==e&&(c=t(s,u)),l>c?new ArrayBuffer(0):(i=c-l,r=new ArrayBuffer(i),a=new Uint8Array(r),o=new Uint8Array(this,l,i),a.set(o),r)}}(),d.prototype.append=function(e){return this.appendBinary(u(e)),this},d.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var s,i=this._buff.length;for(s=64;s<=i;s+=64)t(this._hash,n(this._buff.substring(s-64,s)));return this._buff=this._buff.substring(s-64),this},d.prototype.end=function(e){var t,n,s=this._buff,i=s.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)r[t>>2]|=s.charCodeAt(t)<<(t%4<<3);return this._finish(r,i),n=o(this._hash),e&&(n=p(n)),this.reset(),n},d.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},d.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},d.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},d.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},d.prototype._finish=function(e,n){var s,i,r,a=n;if(e[a>>2]|=128<<(a%4<<3),a>55)for(t(this._hash,e),a=0;a<16;a+=1)e[a]=0;s=8*this._length,s=s.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(s[2],16),r=parseInt(s[1],16)||0,e[14]=i,e[15]=r,t(this._hash,e)},d.hash=function(e,t){return d.hashBinary(u(e),t)},d.hashBinary=function(e,t){var n=i(e),s=o(n);return t?p(s):s},d.ArrayBuffer=function(){this.reset()},d.ArrayBuffer.prototype.append=function(e){var n,i=f(this._buff.buffer,e,!0),r=i.length;for(this._length+=e.byteLength,n=64;n<=r;n+=64)t(this._hash,s(i.subarray(n-64,n)));return this._buff=n-64<r?new Uint8Array(i.buffer.slice(n-64)):new Uint8Array(0),this},d.ArrayBuffer.prototype.end=function(e){var t,n,s=this._buff,i=s.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)r[t>>2]|=s[t]<<(t%4<<3);return this._finish(r,i),n=o(this._hash),e&&(n=p(n)),this.reset(),n},d.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},d.ArrayBuffer.prototype.getState=function(){var e=d.prototype.getState.call(this);return e.buff=c(e.buff),e},d.ArrayBuffer.prototype.setState=function(e){return e.buff=l(e.buff,!0),d.prototype.setState.call(this,e)},d.ArrayBuffer.prototype.destroy=d.prototype.destroy,d.ArrayBuffer.prototype._finish=d.prototype._finish,d.ArrayBuffer.hash=function(e,t){var n=r(new Uint8Array(e)),s=o(n);return t?p(s):s},d})},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.FileHttp=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=n(12),a=n(1),o=n(32),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(o);t.FileHttp=function(){function e(t){s(this,e),this.engine=t,this.queryHttp=t.utils.isSecure?_CUBE_HTTPS_FILE_SERVICE:_CUBE_HTTP_FILE_SERVICE,this.createHttp=t.utils.isSecure?_CUBE_HTTPS_STORAGE_SERVICE:_CUBE_HTTP_STORAGE_SERVICE,this.uploadProcessFiles=new HashMap,this.pendingFiles=[]}return i(e,[{key:"createUpload",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(null==e.md5)return void this.calculate(e,function(s){e.md5=s,t.createUpload(e,n)});var s=e.isOverride||!0,i={token:this.engine.accToken,name:e.name,parentId:e.parentId,permission:e.permission,md5:e.md5,isOverride:s,size:e.size};this._sendPostHttp(r.FileAction.CreateUploadFile,i,function(s,i){if(t.uploadProcessFiles.size()>=4)return t.pendingFiles.push({file:e,callback:n}),!1;if(!s&&200==i.state.code){var r=i.data.fileInfo;r.paused=!1,r.lastProgress=0,r.progressCounts=0,t.uploadProcessFiles.put(r.fileId,r)}n(s,i)},this.createHttp)}},{key:"calculate",value:function(e,t){function n(){var t=o*r,n=t+r>=e.size?e.size:t+r;s.readAsBinaryString(i.call(e,t,n))}var s=new FileReader,i=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice,r=2097152,a=Math.ceil(e.size/r),o=0,l=new u.default;s.onload=function(e){l.appendBinary(e.target.result),o++,o<a?n():t(l.end())},n()}},{key:"upload",value:function(e,t){var n=this,s=this.uploadProcessFiles.get(e.fileId);if(null==s)return!1;null==s.file&&null!=e.file&&(s.file=e.file),s.paused=!1;var i={token:this.engine.accToken,fileId:s.fileId},a=function(e){if(200!=e.state.code)n.uploadProcessFiles.remove(s.fileId);else{var i=e.data.fileInfo;i.size==i.progress?(n.uploadProcessFiles.remove(s.fileId),n.pendingFiles.length>0&&(n.createUpload(n.pendingFiles[0].file,n.pendingFiles[0].callback),n.pendingFiles=n.pendingFiles.slice(1))):s.progress=i.progress}t(!1,e)},o=function(e){n.uploadProcessFiles.remove(s.fileId),t(e)};if("function"==typeof e.customPostMethod)i.file=null,e.customPostMethod({data:i,action:this.createHttp+r.FileAction.Uploader},a,o);else{var u=s.secondUpload?new Blob:s.file.slice(s.progress,s.file.size);u.name=s.name;var l=this._sendFile(r.FileAction.Uploader,{name:"file",value:u},i,function(e,t){e?o(e):a(t)},this.createHttp);null!=l&&(s.xhr=l)}}},{key:"pause",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(null==this.uploadProcessFiles.get(e)||this.uploadProcessFiles.get(e).paused)return!1;var s={fileId:e,token:this.engine.accToken};this._sendPostHttp(r.FileAction.PauseFile,s,function(s,i){s||200!=i.state.code||(t.uploadProcessFiles.get(e).paused=!0),n(s,i)},this.createHttp)}},{key:"_progressTask",value:function(e,t){var n=this,s=this,i=function i(){var r=n.uploadProcessFiles.get(e);null==r||r.paused||(setTimeout(function(){i(e)},2e3),s.progress(e,t))};setTimeout(function(){i()},1e3)}},{key:"progress",value:function(e,t){var n=this,s=this.uploadProcessFiles.get(e);if(null==s)return!1;if(s.progressCounts>200)return t(!0,new a.CubeError(CubeStateCode.RequestTimeout,"Upload file timeout")),this.cancelUpload(e),!1;var i={token:this.engine.accToken,fileId:e};this._sendPostHttp(r.FileAction.ProgressFile,i,function(i,r){i||200!=r.state.code?n.uploadProcessFiles.remove(e):(s.lastProgress==r.data.fileInfo.progress&&s.progressCounts++,s.lastProgress=r.data.fileInfo.progress),t(i,r)},this.createHttp)}},{key:"cancelUpload",value:function(e){var t=this,n=this.uploadProcessFiles.get(e);null!=n&&null!=n.xhr&&n.xhr.abort();var s={fileId:e,token:this.engine.accToken};this._sendPostHttp(r.FileAction.CancelFile,s,function(e,s){if(e||200!=s.state.code)n.paused=!1;else{var i=s.data.fileInfo;t.uploadProcessFiles.remove(i.fileId),t.pendingFiles.length>0&&(t.createUpload(t.pendingFiles[0].file,t.pendingFiles[0].callback),t.pendingFiles=t.pendingFiles.slice(1))}},this.createHttp)}},{key:"_sendPostHttp",value:function(e,t,n){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.queryHttp,i={};for(var r in t)null!=t[r]&&(i[r]=t[r]);NucleusAjax.newRequest(s+e).method("POST").content(i).send(function(e){var t=e.getStatus();if(200===t){var s=void 0;try{s=JSON.parse(e.getData())}catch(t){s=e.getData()}n(!1,s)}else n({status:t})})}},{key:"_sendFile",value:function(e,t,n,s){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.queryHttp;if(window.FormData){var r=new FormData;for(var a in n)r.append(a,n[a]);if(t.value instanceof HTMLElement){var o=t.value.files[0];r.append(t.name,o,o.name)}else t.value instanceof Blob&&r.append(t.name,t.value,t.value.name);var u=new XMLHttpRequest;return u.open("post",i+e,!0),u.onload=function(){if(200===u.status){var e=void 0;try{e=JSON.parse(u.responseText)}catch(t){e=u.responseText}s(!1,e)}else s({status:u.status})},u.send(r),u}}}]),e}()},,,,,,,,,,,,,,,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();t.MessageListener=function(e){function t(){return s(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),a(t,[{key:"onMessageSent",value:function(e){}},{key:"onMessageUploading",value:function(e,t,n){}},{key:"onMessageUploadCompleted",value:function(e){}},{key:"onMessageDownloading",value:function(e,t,n){}},{key:"onMessageDownloadCompleted",value:function(e){}},{key:"onMessageRecalled",value:function(e){}},{key:"onMessageReceived",value:function(e){}},{key:"onMessageCanceled",value:function(e){}},{key:"onMessagePaused",value:function(e){}},{key:"onMessageResumed",value:function(e){}},{key:"onMessageSyncBegin",value:function(){}},{key:"onMessagesSyncing",value:function(e){}},{key:"onMessageSyncEnd",value:function(){}},{key:"onMessageFailed",value:function(e,t){}}]),t}(CubeListener)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.HistoryMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(0),u=n(2);t.HistoryMessage=function(e){function t(e,n){s(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o.MessageType.History));return r.receiver={name:e},r.histories=n,r}return r(t,e),a(t,[{key:"getMessages",value:function(){return this.sns}},{key:"setMessages",value:function(e){this.sns=e}},{key:"toJSON",value:function(){var e=u.MessageEntity.prototype.toJSON.call(this);return e.histories=this.histories,e}}],[{key:"parse",value:function(e){var n=new t(e.receiver,e.sns);return n.receiver=e.to,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sn=e.sn,n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.histories=e.histories,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n}}]),t}(u.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.LocationMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(0),u=n(2);t.LocationMessage=function(e){function t(e,n,r,a){s(this,t);var u=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o.MessageType.Location));return u.receiver={name:e},u.lat=n,u.lng=r,u.address=a,u}return r(t,e),a(t,[{key:"toJSON",value:function(){var e=u.MessageEntity.prototype.toJSON.call(this);return e.lat=this.lat,e.lng=this.lng,e.address=this.address,e}},{key:"setLat",value:function(e){this.lat=e}},{key:"setLng",value:function(e){this.lng=e}},{key:"setAddress",value:function(e){this.address=e}},{key:"getLat",value:function(){return this.lat}},{key:"getLng",value:function(){return this.lng}},{key:"getAddress",value:function(){return this.address}}],[{key:"parse",value:function(e){var n=new t(e.receiver,e.lat,e.lng,e.address);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sn=e.sn,n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.histories=e.histories,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n}}]),t}(u.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RichContentMessage=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),u=n(0),l=n(2),c=(n(19),n(20));n(21),t.RichContentMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.RichContent));return n.receiver={name:e},n.messages=new Array,n.md5=0,n}return r(t,e),o(t,[{key:"addMessage",value:function(e){this.messages.push(e)}},{key:"removeMessage",value:function(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t]==e){this.messages.splice(t,1);break}}},{key:"addText",value:function(e){var t={type:"text",content:e};this.messages.push(t)}},{key:"addImage",value:function(e){var t=this;this.md5++;var n=new c.ImageMessage(this.receiver.name);n.setFormFile(e,function(){t.md5--}),this.messages.push(n)}},{key:"getMessages",value:function(){return this.sns}},{key:"setMessages",value:function(e){this.sns=e}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.contents=this.messages,e}}],[{key:"upload",value:function(e,n){for(var s=this,i=0,r=0;r<n.messages.length;r++){var o=function(r){if("image"==n.messages[r].type){if(i++,n.md5>0)return s.md5Time=setInterval(function(){t.upload(e,n)},500),{v:void 0};clearInterval(s.md5Time),n.messages[r]._postData(n.messages[r],function(t,s){var a=s.data.file,o={type:"image",file:{url:a.url,width:a.width,height:a.height}};i--,n.messages.splice(r,1,o),0==i&&cube.getMessageService().sendMessage(e,n)})}}(r);if("object"===(void 0===o?"undefined":a(o)))return o.v}}},{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.anonymous=e.anonymous,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n.messages=e.contents,delete n.md5,n}}]),t}(l.MessageEntity)},,,,,,,,,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.FileMessageStatus={None:"none",Downloading:"downloading",Uploading:"uploading",Succeed:"succeed",Failed:"failed"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageStatus={CREATE:"create",FAIL:"fail",INPROGRESS:"inprogress",RECALL:"recall",SUCCESS:"success"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.FileAction={PrepareUpload:"/message/file/broken/prepare/",StartUpload:"/message/file/broken/upload/",PauseUpload:"/message/file/broken/pause/",ResumeUpload:"/message/file/broken/resume/",GetProgress:"/message/file/broken/progress/",RichMessageUpload:"/richmessage/file/upload/"}},,,,,,,,,,,,,,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageServiceWorker=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),u=n(134),l=n(50),c=n(135),f=n(69),p=n(68),d=n(0),g=n(2),y=n(19),h=n(6),v=n(27),m=n(24),b=n(23),M=n(51),S=n(52),_=n(53),C=n(21),w=n(20),k=n(29),T=n(28),O=(n(70),n(141)),F=n(139),E=n(5),P=n(26),R=n(25),A=n(33);t.MessageServiceWorker=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,l.MessageListener,CELLET.Messaging));return n.msgQueue=new F.MessageQueue(n,n.delegate),n.queryHistoryCallback={},n.meassgeCallback=[],n.dbService=new c.DBMessageService(e),n.pendingMessageList=[],n.recentService={},n.callback=new Map,n._msgSizeThreshold=2048,n.lastTimestamp=0,n.session=null,n.notifyTimer=0,n.remainingTimer=0,n.lastSessionName=null,n.syncMessageList=[],n.syncMessageNumber=0,n.syncMessageSns=[],n.syncLocalData=[],n.historyLocalData={},n}return r(t,e),o(t,[{key:"_fileUpload",value:function(e,t){var n=this;this.fileHttp.upload(e.file,function(s,i){if(s||200!=i.state.code)nucleus.getLogger().e("CubeConference#_fileUpload","Error of "+i.state.code+" "+i.state.desc);else{var r=i.data.fileInfo;if(r.size==r.progress){e.status=f.MessageStatus.SUCCESS,e.fileStatus=p.FileMessageStatus.Succeed;var a={md5:e.file.md5,size:e.file.size,modified:Date.now(),name:e.file.name,url:r.url,duration:e.file.duration,key:r.fileId,width:e.file.width,height:e.file.height,path:e.file.path};e.file=a,n.delegate.onMessageUploadCompleted(e),t(e)}else{n.fileHttp.uploadProcessFiles.get(r.fileId).file.progress=r.progress,n.delegate.onMessagePaused(e,r.progress,r.size)}}})}},{key:"querMessagesBySns",value:function(e,t){this.dbService.queryMessageBySns(e,t)}},{key:"pauseMessage",value:function(e){if(null==e)return nucleus.getLogger().e("CubeMessage#pauseMessage","sn is null"),!1;var t=this.msgQueue.read(e);null!=t.file&&this.fileHttp.pause(t.file.fileId)}},{key:"resumeMessage",value:function(e){var t=this;if(null==e)return nucleus.getLogger().e("CubeMessage#resumeMessage","sn is null"),!1;var n=this.msgQueue.read(e);null!=n.file&&(this.delegate.onMessageResumed(n),this._fileUpload(n),setTimeout(function(){t.fileHttp._progressTask(n.file.fileId,function(e,s){if(e||200!=s.state.code)t.delegate.onMessageFailed(CubeStateCode.UploadFailed,n);else{var i=s.data.fileInfo;i.progress=i.progress==i.size?i.progress-1:i.progress,t.delegate.onMessageUploading(n,i.progress,i.size)}})},200))}},{key:"_getWidthAndHeight",value:function(e,t){var n=new FileReader,s={};n.onload=function(e){var n=e.target.result,i=new Image;i.onload=function(){s.width=i.width,s.height=i.height,t(s)},i.src=n},n.readAsDataURL(e)}},{key:"_upload",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e){t._handleSendMessage(e)},s=e.file,i=e.formFile;e.fileOldName=s.name,s.name=Date.now()+s.name;var r=function(r,a){if(r)return void t.delegate.onMessageFailed(CubeStateCode.UploadFailed,e);if(200==a.state.code){var o=a.data.fileInfo;o.file=i,o.customPostMethod=e.customPostMethod,o.name=e.fileOldName;for(var u in s)null==o[u]&&(o[u]=s[u]);e.file=o,t._fileUpload(e,n),e.status=f.MessageStatus.INPROGRESS,e.fileStatus=p.FileMessageStatus.Uploading,setTimeout(function(){t.fileHttp._progressTask(o.fileId,function(n,s){if(n||200!=s.state.code)t.delegate.onMessageFailed(CubeStateCode.UploadFailed,e);else{var i=s.data.fileInfo;i.progress=i.progress==i.size?i.progress-1:i.progress,t.delegate.onMessageUploading(e,i.progress,i.size)}})},200)}else t.delegate.onMessageFailed(CubeStateCode.UploadFailed,e)};if(e.type==d.MessageType.Image&&null!=e.formFile)return void this._getWidthAndHeight(e.formFile,function(e){s.width=e.width,s.height=e.height,t.fileHttp.createUpload(s,r)});this.fileHttp.createUpload(s,r)}},{key:"sendMessage",value:function(e,t){if(null==e&&null==t)return nucleus.getLogger().e("CubeMessage#sendMessage","parameter is null"),!1;if("string"!=typeof this.session.name)return"string"!=typeof t&&(t.status=f.MessageStatus.FAIL,t.fileStatus&&(t.fileStatus=p.FileMessageStatus.Failed)),!1;for(var n=e,s=Date.now();s<=this.lastTimestamp;)s+=1;if(this.lastTimestamp=s,"string"==typeof e&&!(n=this._toTextMessage(e,t)))return!1;if(n.sender={name:this.session.name,displayName:this.session.displayName},n.sendTime=this.lastTimestamp,n.timestamp=this.lastTimestamp,n.fromDevice=this.engine.getDeviceInfo(),n.direction=C.MessageDirection.Sent,this.msgQueue.enqueue(n),!this.engine.registered)return this.dbService.storageMessage(n),!0;if(null!=n&&n.type===d.MessageType.RichContent){return!0}if(!(n instanceof h.FileMessage&&null==n.file.url))return this._handleSendMessage(n);n.fileStatus=p.FileMessageStatus.Uploading,n.status=f.MessageStatus.INPROGRESS,this._upload(n)}},{key:"_handleSendMessage",value:function(e){if(!nucleus.talkService.isCalled(CELLET.Messaging))return!1;var t={message:e.toJSON(),token:this.engine.accToken},n=this.engine.connect.send(CELLET.Messaging,CubeConst.ActionPush,t);return this.dbService.storageMessage(e),n?(e.status=f.MessageStatus.INPROGRESS,e.fileStatus&&(e.fileStatus=f.MessageStatus.Uploading),!0):(e.status=f.MessageStatus.FAIL,e.fileStatus&&(e.fileStatus=f.MessageStatus.Failed),this.msgQueue.dequeue(e.sn),!1)}},{key:"reSendMessage",value:function(e){var t=this;if(null==e)return nucleus.getLogger().e("CubeMessage#reSendMessage","sn is null"),!1;var n=this.msgQueue.read(e);null!=n?this.sendMessage(n):this.dbService.queryMessageBySns([e],function(e,n){null!=n&&t.sendMessage(n[0])})}},{key:"deleteMessage",value:function(e){if(null==e)return nucleus.getLogger().e("CubeMessage#deleteMessage","sn is null"),!1;this.dbService.delMessageBySn(e,function(e){})}},{key:"recallMessage",value:function(e){return null==e?(nucleus.getLogger().e("CubeMessage#recallMessage","sn is null"),!1):null!=this.session&&null!=this.session.name&&this.engine.connect.send(CELLET.Messaging,CubeConst.ActionRecall,{sn:e,token:this.engine.accToken})}},{key:"sendHistoryMessage",value:function(e,t){var n=this;if(null==t||null==e)return nucleus.getLogger().e("CubeMessage#sendHistoryMessage","destinations or sns is null"),!1;var s=t instanceof Array?t:[t],i=e instanceof Array?e:[e.toString()];this.dbService.queryMessageBySns(s,function(e,t){if(!e){var s=!0,r=!1,a=void 0;try{for(var o,u=i[Symbol.iterator]();!(s=(o=u.next()).done);s=!0){var l=o.value,c=new M.HistoryMessage(l,t);n.sendMessage(c)}}catch(e){r=!0,a=e}finally{try{!s&&u.return&&u.return()}finally{if(r)throw a}}}})}},{key:"cancelMessage",value:function(e){var t=this;if(null==e)return nucleus.getLogger().e("CubeMessage#cancelMessage","message is null"),!1;var n="object"==(void 0===e?"undefined":a(e))?e.sn:e,s=this.msgQueue.read(n);return!!s&&(null!=s.file&&null!=s.file.fileId&&this.fileHttp.cancelUpload(s.file.fileId),this.dbService.queryMessageBySns([n],function(e,n,s){!e&&null!=n&&n.length>0&&s[0].status==f.MessageStatus.CREATE&&(n[0].status=f.MessageStatus.FAIL,t.dbService.storageMessage(n[0]))}),this.msgQueue.dequeue(n),this.delegate.onMessageCanceled(s),!0)}},{key:"queryHistoryMessage",value:function(e){if(null==e||"object"==(void 0===e?"undefined":a(e))&&null==e.cubeId)return nucleus.getLogger().e("CubeMessage#queryHistoryMessage","cubeId is null"),!1;var t=(new Date).getTime();"object"==(void 0===e?"undefined":a(e))&&"function"==typeof e.cubeCallback&&(this.queryHistoryCallback[t]=e.cubeCallback);var n=e.sinceTimestamp||0;this.historyLocalData[t]=[];var s={chatId:e.cubeId||e,since:n,until:e.untilTimestamp||t,offset:e.offset||1,count:e.conut||10,timestamp:t};this.engine.connect.send(CELLET.Messaging,CubeConst.ActionMessageHistorySns,s)}},{key:"queryHistoryMessageHttp",value:function(e){var t=this;if(null==e||"object"==(void 0===e?"undefined":a(e))&&null==e.cubeId)return nucleus.getLogger().e("CubeMessage#queryHistoryMessage","cubeId is null"),!1;e.cubeCallback=null==e.cubeCallback?function(){}:e.cubeCallback;var n=e.sinceTimestamp||0,s=this;this.dbService.getMessageByColumGT("sendTimestamp",n,!0,function(i,r){if(!i){var a=s._getHttpUrl(O.MessageAction.MessageSync),o={chatId:e.cubeId||e,since:n,until:e.untilTimestamp||(new Date).getTime(),offset:e.offset||1,count:e.conut||20,token:t.engine.accToken,syncType:"simple"};NucleusAjax.newRequest(a).method("POST").content(o).send(function(t){if(200!=t.status)return void e.cubeCallback([]);var n=JSON.parse(t.data);if(200==n.state.code){var i=n.data.messages,a=s._getPullSn(r,i,!1),o={},u=!0,l=!1,c=void 0;try{for(var f,p=i[Symbol.iterator]();!(u=(f=p.next()).done);u=!0){var d=f.value;o[d.sn]=!0}}catch(e){l=!0,c=e}finally{try{!u&&p.return&&p.return()}finally{if(l)throw c}}var g=function(t){var n=t?t[cubeId]:[],s=r.filter(function(e){return o[e.sn]});e.cubeCallback(s.concat(n))};s.syncMessageBySns(a,g)}else e.cubeCallback([])})}})}},{key:"parseMessage",value:function(e){null!=e&&"object"==(void 0===e?"undefined":a(e))||nucleus.getLogger().e("CubeConference#parseMessage","Error of parameters");var t=[d.MessageType.Text,d.MessageType.Custom,d.MessageType.File,d.MessageType.Image,d.MessageType.Voice,d.MessageType.Video,d.MessageType.Whiteboard,d.MessageType.Card,d.MessageType.History,d.MessageType.Location,d.MessageType.RichContent,d.MessageType.Reply,d.MessageType.Receipt],n=[new y.TextMessage,new m.CustomMessage,new h.FileMessage,new w.ImageMessage,new k.VoiceMessage,new T.VideoMessage,new v.WhiteboardMessage,new b.CardMessage,new M.HistoryMessage,new S.LocationMessage,new _.RichContentMessage,new P.ReplyMessage,new R.ReceiptMessage],s=this._createObj(t,n);if(null!=s[e.type]){var i=s[e.type];for(var r in e)i.hasOwnProperty(r)&&(i[r]=e[r]);return i}return null}},{key:"_createObj",value:function(e,t){for(var n={},s=0;s<e.length;s++){var i=e[s],r=t[s];n[i]=r}return n}},{key:"_endMessageSync",value:function(){var e=this;!function t(){setTimeout(function(){e.syncMessageNumber>0?t():(e.engine.triggerCubeEngineState(CubeState.Ready),nucleus.getLogger().d("CubeMessageService","end Message Sync"),e.syncLocalData=[],e.delegate.onMessageSyncEnd())},300)}()}},{key:"_sendSyncTcp",value:function(e,t,n){var s={since:t,offset:e,count:200,until:n};this.engine.connect.send(CELLET.Messaging,CubeConst.ActionMsgSync,s)}},{key:"_processMsgSyncAck",value:function(e){var t=this,n=e.getParamAsString("state"),s=e.getParamAsString("data"),i=function(){t.syncMessageNumber++,t.engine.connect.send(CELLET.Messaging,CubeConst.ActionMsgPull,{sns:t.syncMessageSns}),t.syncMessageSns=[]};if(200==n.code){s.pageCurrent==s.pageTotal&&this._sendSyncTcp(s.page.offset+1,s.page.since,s.page.until);var r=this._getPullSn(this.syncLocalData,s.sns);this.syncMessageSns=this.syncMessageSns.concat(r),1==s.pageCurrent&&1==s.page.offset&&i()}else i(),this._endMessageSync()}},{key:"_processMsgPullAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data");if(200==t.code){var s=n.timestamp;if(null!=s){var i=[],r=!0,a=!1,o=void 0;try{for(var u,l=n.messages[Symbol.iterator]();!(r=(u=l.next()).done);r=!0){var c=u.value;i.push(this._parseMessageJson(c))}}catch(e){a=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(a)throw o}}var f={};this.historyLocalData[s]=this.historyLocalData[s].concat(i);var p=!0,d=!1,g=void 0;try{for(var y,h=this.historyLocalData[s][Symbol.iterator]();!(p=(y=h.next()).done);p=!0){f[y.value.sn]=!0}}catch(e){d=!0,g=e}finally{try{!p&&h.return&&h.return()}finally{if(d)throw g}}return void(n.pageCurrent==n.pageTotal&&this._historyCallback(s))}if(this.syncMessageList=this.syncMessageList.concat(n.messages),n.pageCurrent==n.pageTotal){var v=this._toMessagesMap(this.syncMessageList);if(this.delegate.onMessagesSyncing(v),null!=this.recentService){var m=[],b=!0,M=!1,S=void 0;try{for(var _,C=this.syncMessageList[Symbol.iterator]();!(b=(_=C.next()).done);b=!0){var w=_.value;m.push(this._parseMessageJson(w))}}catch(e){M=!0,S=e}finally{try{!b&&C.return&&C.return()}finally{if(M)throw S}}this.recentService._saveRecents(m)}this.syncMessageList=[],this.syncMessageNumber--}}else this.syncMessageNumber>0&&this.syncMessageNumber--}},{key:"_processMessageHistorySnsAck",value:function(e){var t=this,n=e.getParamAsString("state"),s=e.getParamAsString("data");if(200!=n.code)return void this._historyCallback([]);var i=s.sns.map(function(e){return e.sn});this.dbService.queryMessageBySns(i,function(e,n){if(e)return void t._historyCallback(s.timestamp);n=null==n?[]:n;var i=s.sns,r=t._getPullSn(n,i,!1,!1),a={},o=!0,u=!1,l=void 0;try{for(var c,f=i[Symbol.iterator]();!(o=(c=f.next()).done);o=!0){var p=c.value;a[p.sn]=!0}}catch(e){u=!0,l=e}finally{try{!o&&f.return&&f.return()}finally{if(u)throw l}}var d=n.filter(function(e){return a[e.sn]});if(t.historyLocalData[s.timestamp]=d,r.length>0)return void t.engine.connect.send(CELLET.Messaging,CubeConst.ActionMsgPull,{timestamp:s.timestamp,sns:r});t._historyCallback(s.timestamp)})}},{key:"_historyCallback",value:function(e){if(null!=this.queryHistoryCallback[e]){var t=this.historyLocalData[e].sort(function(e,t){return e.sendTime-t.sendTime});this.queryHistoryCallback[e](t),delete this.queryHistoryCallback[e]}delete this.historyLocalData[e]}},{key:"_toMessagesMap",value:function(e){for(var t=void 0,n=void 0,s={},i=[],r=0;r<e.length;r++){var a=this._parseMessageJson(e[r]);null==a||i.includes(a.sn)||(this.msgQueue.dequeue(e[r].sn),a.status=e[r].recall?f.MessageStatus.RECALL:f.MessageStatus.SUCCESS,this.dbService.storageMessage(a),t=this.engine.accName==a.sender.name?a.receiver.name:a.sender.name,n=null==s[t]?new Array:s[t],n.push(a),s[t]=n,i.push(a.sn))}return s}},{key:"_sendSyncHttp",value:function(e,t,n,s){var i=this,r=this,a={since:n,offset:t,count:200,token:this.engine.accToken,syncType:"simple"},o=this._getHttpUrl(O.MessageAction.MessageSync);nucleus.getLogger().i("CubeMessageService","syncMessage Request begin ");!function u(l){if(l>=3)return nucleus.getLogger().i("CubeMessageService","syncMessage Request TimeOut"),void i.delegate.onMessageFailed(E.StateCode.SyncMessageTimeout);var c=!1,f=NucleusAjax.newRequest(o);f.method("POST").content(a).send(function(i){if(200==i.status){nucleus.getLogger().i("CubeMessageService","syncMessage Request end"),c=!0;var a=JSON.parse(i.data);if(200==a.state.code){var o=a.data.messages,u=r._getPullSn(e,o),f=function(e){e&&r.delegate.onMessagesSyncing(e)};o.length<l?f=function(e){e&&r.delegate.onMessagesSyncing(e),r._endMessageSync()}:r._sendSyncHttp(e,t+1,n,s),r.syncMessageBySns(u,f)}else 1113==a.state.code&&r._endMessageSync()}}),setTimeout(function(){c||(f._xmlhttp.abort(),u(l+1))},3e4)}(0)}},{key:"_getPullSn",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];e=null==e?[]:e;var i=this._getDifSn(e,t),r=[];if(s){var a=!0,o=!1,u=void 0;try{for(var l,c=t[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var f=l.value;r.push(f.timestamp),f.updateTime>f.timestamp&&!i.includes(f.sn)&&i.push(f.sn)}}catch(e){o=!0,u=e}finally{try{!a&&c.return&&c.return()}finally{if(o)throw u}}}if(n&&null!=this.session&&null!=this.session.name){var p=Number.parseInt(localStorage.getItem("CubeMessageSyncTime_"+this.session.name));Number.isNaN(p)||r.push(p);var d=Math.max.apply(null,r);localStorage.setItem("CubeMessageSyncTime_"+this.session.name,d)}return i}},{key:"_getDifSn",value:function(e,t){var n=[],s=[],i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var l=o.value;n.push(l.sn)}}catch(e){r=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(r)throw a}}var c=!0,f=!1,p=void 0;try{for(var d,g=e[Symbol.iterator]();!(c=(d=g.next()).done);c=!0){var y=d.value;s.push(y.sn)}}catch(e){f=!0,p=e}finally{try{!c&&g.return&&g.return()}finally{if(f)throw p}}return n.filter(function(e){return!s.includes(e)})}},{key:"syncMessage",value:function(e){var t=this;if(null==e)return!1;var n=this;this.delegate.onMessageSyncBegin(),this.engine.triggerCubeEngineState(CubeState.Busy),e=Number.parseInt(e),this.dbService.getMessageByColumGT("sendTimestamp",e,!0,function(s,i){s||(t.syncLocalData=i,n._sendSyncTcp(1,e))})}},{key:"saveMessage",value:function(e){return null==e?(nucleus.getLogger().e("CubeConference#saveMessage","message is null"),!1):!e instanceof g.MessageEntity?(nucleus.getLogger().e("CubeConference#saveMessage","message is not CubeMessagEntity"),!1):void this.dbService.storageMessage(e)}},{key:"syncMessages",value:function(){if(null==this.session||null==this.session.name)return!1;var e=Date.now(),t=localStorage.getItem("CubeMessageSyncTime_"+this.session.name);console.log("",t),t=null==t?0:t,t=Number.parseInt(t),e-t>2592e6&&(t=e-2592e6),this.syncMessage(t)}},{key:"_getHttpUrl",value:function(e){return _CUBE_HTTP_SERVICES+e}},{key:"syncMessageBySns",value:function(e,t){var n=this,s=this._getHttpUrl("/v3/message/pull"),i={sns:JSON.stringify(e),token:this.engine.accToken};nucleus.getLogger().i("CubeMessageService","syncMessageBySns Request begin "),NucleusAjax.newRequest(s).method("POST").content(i).send(function(e){nucleus.getLogger().i("CubeMessageService","syncMessageBySns Request end");var s=JSON.parse(e.data),i={};if(200==s.state.code)for(var r=s.data,a=void 0,o=void 0,u=[],l=0;l<r.length;l++){var c=n._parseMessageJson(r[l]);null==c||u.includes(c.sn)||(n.msgQueue.dequeue(r[l].sn),c.status=r[l].recall?f.MessageStatus.RECALL:f.MessageStatus.SUCCESS,n.dbService.storageMessage(c),a=n.engine.accName==c.sender.name?c.receiver.name:c.sender.name,o=null==i[a]?new Array:i[a],o.push(c),i[a]=o,u.push(c.sn))}else i=!1;"function"==typeof t&&t(i)})}},{key:"queryTopConcats",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},t=this._getHttpUrl("/recent/message/top/list/"),n={tag:window.nucleus.tag,master:this.engine.accName,token:this.engine.accToken};NucleusAjax.newRequest(t).method("POST").content(n).send(function(t){var n=JSON.parse(t.data),s=n.data.recents;200==n.state.code&&e(s)})}},{key:"setTop",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};this.callback.set("setTopCallback",n);var s={name:e+"",top:t?1:0};return this.engine.connect.send(CELLET.Messaging,CubeConst.ActionUpdateTop,s)}},{key:"queryMessageBySns",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=e instanceof Array,s=n?e:[e];this.dbService.queryMessageBySns(s,function(e,s){if(null==s)return void t(s);var i=n?s:s[0];t(i)})}},{key:"syncMessageTcp",value:function(){var e={chartId:this.engine.session.name,since:0,count:300};return this.engine.connect.send(CELLET.Messaging,CubeConst.ActionMsgSync,e)}},{key:"onRegisterStateChanged",value:function(e){var t=this,n=this;if(this.session=e,this.engine.registered){if(this.dbService.startup(),this.fileHttp=new A.FileHttp(this.engine),this.recentService=cube.getRecentSessionService(),null==this.lastSessionName||this.lastSessionName==this.session.name){var s=Date.now()-18e4;this.dbService.getMessageByColumGT("sendTimestamp",s,!0,function(e,s,i){if(!e){var r=!0,a=!1,o=void 0;try{for(var u,l=i[Symbol.iterator]();!(r=(u=l.next()).done);r=!0){var c=u.value;if(c.status==f.MessageStatus.CREATE){var p=JSON.parse(c.json),d=n._parseMessageJson(p);t._handleSendMessage(d)}}}catch(e){a=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(a)throw o}}}})}this.lastSessionName=this.session.name,window.cube.config.autoSyncMsg&&this.syncMessages(),this.dbService.queryMessageByColumn("status",f.MessageStatus.CREATE,function(e,s){if(!e){var i=!0,r=!1,a=void 0;try{for(var o,u=s[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var l=o.value;l.type==d.MessageType.Receipt&&t._handleSendMessage(n.parseMessage(l))}}catch(e){r=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(r)throw a}}}})}}},{key:"onDialogue",value:function(e,t){switch(e){case CubeConst.ActionPushAck:this._processPushAck(t);break;case CubeConst.ActionPushNotify:this._processPushNotify(t);break;case CubeConst.ActionPushSync:this._processPushSync(t);break;case CubeConst.ActionRecallAck:this._processRecallAck(t);break;case CubeConst.ActionRecallSync:this._processRecallSync(t);break;case CubeConst.ActionRecallNotify:this._processRecallNotify(t);break;case CubeConst.ActionUpdateTop:this._processUpdateTop(t);break;case CubeConst.ActionUpdateTopAck:this._processUpdateTopAck(t);break;case CubeConst.ActionMsgSyncAck:this._processMsgSyncAck(t);break;case CubeConst.ActionMsgPullAck:this._processMsgPullAck(t);break;case CubeConst.ActionMessageHistorySnsAck:this._processMessageHistorySnsAck(t)}}},{key:"_handleSendReceipt",value:function(e){var t=this;if(null==e)return!1;e.type==d.MessageType.Receipt&&this.dbService.queryMessageByColumn("receipted",!1,function(n,s){var i=!0,r=!1,a=void 0;try{for(var o,u=s[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var l=o.value,c=null!=e.group&&l.sender.name!=t.session.name&&l.receiver.name==e.group.name,f=l.sender.name==e.receiver.name&&l.receiver.name==t.session.name;(c||f)&&(l.receipted=!0,t.dbService.storageMessage(l))}}catch(n){r=!0,a=n}finally{try{!i&&u.return&&u.return()}finally{if(r)throw a}}})}},{key:"_processPushSync",value:function(e){var t=e.getParamAsString("data"),n=this._parseMessageJson(t.message);this._handleSendReceipt(n),this._updateRecent(n),this.delegate.onMessageSent(n)}},{key:"_processPushAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data");if(n||nucleus.getLogger().i("CubeMessageService nucleus dialect error",JSON.stringify(n)),200!=t.code&&1112!=t.code)return void this.delegate.onMessageFailed(t.code);var s=this._parseMessageJson(n.message),i=this.msgQueue.read(n.message.sn);200===t.code?i?(this.msgQueue.dequeue(i.sn),s.type==d.MessageType.File&&(s.file=i.file=Object.assign(s.file,i.file)),s.status=f.MessageStatus.SUCCESS,this._updateRecent(s),this.delegate.onMessageSent(s),this.dbService.storageMessage(s),this._handleSendReceipt(s)):this.delegate.onMessageFailed(CubeStateCode.Declined,s):1112===t.code?(s.file.path=i.file.path,s.status=f.MessageStatus.SUCCESS,s.fileStatus=p.FileMessageStatus.Succeed,this._updateRecent(s),this.delegate.onMessageSent(s),this.msgQueue.dequeue(i.sn),this.delegate.onMessageUploadCompleted(s),this.dbService.storageMessage(s)):(i&&this.msgQueue.dequeue(i.sn),this.delegate.onMessageFailed(t.code,s))}},{key:"_processPushNotify",value:function(e){var t=this,n=e.getParamAsString("data");n||nucleus.getLogger().i("CubeMessageService nucleus dialect error",JSON.stringify(n));var s=this._parseMessageJson(n.message);if(null!=s)if(s.status=f.MessageStatus.SUCCESS,s.type==d.MessageType.Receipt&&this.dbService.queryMessageByColumn("receipted",!1,function(e,n){var i="receiver";null!=s.group&&(i="group");var r=!0,a=!1,o=void 0;try{for(var u,l=n[Symbol.iterator]();!(r=(u=l.next()).done);r=!0){var c=u.value;c.sender.name==t.session.name&&null!=c[i]&&c[i].name==s[i].name&&(c.receipted=!0,t.dbService.storageMessage(c))}}catch(e){a=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(a)throw o}}}),s.type==d.MessageType.Text||s.type==d.MessageType.Custom||s.type==d.MessageType.Card)this._updateRecent(s),this.delegate.onMessageReceived(s),this.dbService.storageMessage(s);else if(s.status=f.MessageStatus.INPROGRESS,s.type===d.MessageType.Whiteboard){if(void 0!==s._fetchData){var i=this;s._fetchData(function(e){e.status=f.MessageStatus.SUCCESS,i._updateRecent(e),i.delegate.onMessageReceived(e),i.dbService.storageMessage(e)},function(e,t){e.status=f.MessageStatus.FAIL,i.delegate.onMessageFailed(t,e)})}}else s.fileStatus&&(s.sender.name!=this.session.name?s.fileStatus=p.FileMessageStatus.None:s.fileStatus=p.FileMessageStatus.Succeed),this._updateRecent(s),this.delegate.onMessageReceived(s),this.dbService.storageMessage(s)}},{key:"_processRecallAck",value:function(e){if(200==e.getParamAsString("state").code){var t=e.getParamAsString("data"),n=this._parseMessageJson(t.message);null!=n?(n.status=f.MessageStatus.RECALL,n.fileStatus&&(n.fileStatus=p.FileMessageStatus.Succeed),this.delegate.onMessageRecalled(n)):this.delegate.onMessageFailed(CubeStateCode.RecallError,n)}else this.delegate.onMessageFailed(CubeStateCode.RecallError)}},{key:"_processRecallSync",value:function(e){var t=e.getParamAsString("data"),n=this._parseMessageJson(t.message);this.delegate.onMessageRecalled(n)}},{key:"_processRecallNotify",value:function(e){var t=e.getParamAsString("data"),n=this._parseMessageJson(t.message);this.delegate.onMessageRecalled(n)}},{key:"_processUpdateTop",value:function(e){var t=(e.getParamAsString("state"),e.getParamAsString("data"));null!=t&&this.delegate.onConcatTop(t)}},{key:"_processUpdateTopAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data");200==t.code&&null!=n&&this.callback.get("setTopCallback")(n)}},{key:"_parseMessageJson",value:function(e){var t=null;if(e||nucleus.getLogger().i("CubeMessageService _parseMessageJson json error",JSON.stringify(e)),e.type==d.MessageType.Text?t=y.TextMessage.parse(e):e.type==d.MessageType.Image?t=w.ImageMessage.parse(e):e.type==d.MessageType.Voice?t=k.VoiceMessage.parse(e):e.type==d.MessageType.Video?t=T.VideoMessage.parse(e):e.type==d.MessageType.Whiteboard?t=v.WhiteboardMessage.parse(e):e.type==d.MessageType.File?t=h.FileMessage.parse(e):e.type==d.MessageType.Custom?t=m.CustomMessage.parse(e):e.type==d.MessageType.Card?t=b.CardMessage.parse(e):e.type==d.MessageType.History?t=M.HistoryMessage.parse(e):e.type==d.MessageType.Location?t=S.LocationMessage.parse(e):e.type==d.MessageType.RichContent?t=_.RichContentMessage.parse(e):e.type==d.MessageType.Reply?t=P.ReplyMessage.parse(e):e.type==d.MessageType.Receipt?t=R.ReceiptMessage.parse(e):nucleus.getLogger().w("CubeMessageService","Error message json format: "+JSON.stringify(e)),null!=t){if(e.header)for(var n in e.header)t.setHeader(n,e.header[n]);t.anonymous=e.anonymous,t.direction=this.engine.accName==t.sender.name?C.MessageDirection.Sent:C.MessageDirection.Received}return t}},{key:"_toTextMessage",value:function(e,t){if("string"==typeof t){var n=new y.TextMessage(e,t);return n.content.length>this._msgSizeThreshold?(this.delegate.onMessageFailed(CubeStateCode.ContentTooLong,n),!1):n}return t instanceof g.MessageEntity&&(null!=e&&(t.receiver={name:e}),this.parseMessage(t))}},{key:"_updateRecent",value:function(e){null!=this.recentService&&this.recentService._updateRecent(e)}}]),t}(u.MessageService)},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";var s=n(86),i=n(50),r=n(20),a=n(28),o=n(29),u=n(23),l=n(24),c=n(6),f=n(19),p=n(26),d=n(27),g=n(51),y=n(53),h=n(52),v=n(0),m=n(25);!function(e){e.CubeMessageServiceWorker=s.MessageServiceWorker,e.CubeMessageListener=i.MessageListener,e.CubeImageMessage=r.ImageMessage,e.CubeVideoMessage=a.VideoMessage,e.CubeVoiceMessage=o.VoiceMessage,e.CubeCardMessage=u.CardMessage,e.CubeCustomMessage=l.CustomMessage,e.CubeFileMessage=c.FileMessage,e.CubeTextMessage=f.TextMessage,e.CubeReplyMessage=p.ReplyMessage,e.CubeHistoryMessage=g.HistoryMessage,e.CubeWhiteboardMessage=d.WhiteboardMessage,e.CubeRichContentMessage=y.RichContentMessage,e.CubeLocationMessage=h.LocationMessage,e.CubeReceiptMessage=m.ReceiptMessage,e.CubeMessageType=v.MessageType}(window)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();t.MessageService=function(e){function t(){return s(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),a(t,[{key:"sendMessage",value:function(e,t){}},{key:"reSendMessage",value:function(e){}},{key:"sendHistoryMessage",value:function(e,t){}},{key:"recallMessage",value:function(e){}},{key:"cancelMessage",value:function(e){}},{key:"pauseMessage",value:function(e,t){}},{key:"resumeMessage",value:function(e){}},{key:"replyMessage",value:function(e,t){}},{key:"deleteMessage",value:function(e){}},{key:"queryHistoryMessage",value:function(e,t,n,s,i,r){}},{key:"parseMessage",value:function(e){}},{key:"saveMessage",value:function(e){}},{key:"syncMessages",value:function(){}},{key:"setTop",value:function(e,t,n){}}]),t}(CubeService)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.DBMessageService=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=n(136),a=n(138),o=n(137),u=n(0),l=n(21),c=n(19),f=n(6),p=n(27),d=n(20),g=n(29),y=n(28),h=n(23),v=n(24),m=n(26),b=n(25);t.DBMessageService=function(){function e(t){s(this,e),this.engine=t,this.dbm=null}return i(e,[{key:"startup",value:function(){this.dbm=new CubeDBManager("CubeMessageDataBase_"+this.engine.accName),console.log(""),this.dbm.loadEntity(r.CubeDBMessage),this.dbm.loadEntity(a.CubeDBSyncMessage),this.dbm.loadEntity(o.CubeDBReceiptMessage),this.dbm.connect(function(){})}},{key:"shutdown",value:function(){this.dbm&&this.dbm.disconnect(function(){}),this.dbm=null}},{key:"storageMessage",value:function(e){var t=this;if(!this.dbm)return void setTimeout(function(){t.storageMessage(e)},500);if(e.type!=u.MessageType.Receipt){var n=e.toJSON();e.fileStatus&&(n.fileStatus=e.fileStatus);var s=new r.CubeDBMessage(e.sn,e.sn,JSON.stringify(e.getSender()),JSON.stringify(e.getReceiver()),e.group?JSON.stringify(e.group):null,e.type,e.timestamp,e.getStatus(),JSON.stringify(e.getFromDevice()),JSON.stringify(e.getReceivedDevices()),e.isReceipted()?1:0,e.anonymous?1:0,JSON.stringify(n));this.dbm.setEntity(s,function(e){})}}},{key:"storageSyncMessage",value:function(e,t){var n=this,s=this;if(!this.dbm)return void setTimeout(function(){n.storageSyncMessage(e)},500);this.querySyncMessage(function(n,i){var r=i[0];r&&r.offline&&(e.offline=r.offline),r&&r.offlineAll&&(e.offlineAll=r.offlineAll);var o=new a.CubeDBSyncMessage(e.name,e.name,null,null,e.offline,e.offlineAll);s.dbm.setEntity(o,function(e){t()})})}},{key:"storageReceiptMessage",value:function(e){var t=this;if(!this.dbm)return void setTimeout(function(){t.storageReceiptMessage(e)},500);this.queryReceiptMessageBySn(e.sn,function(e){if(null==e){var n=e.toJSON(),s=new o.CubeDBReceiptMessage(e.sn,n);t.dbm.setEntity(s,function(e){})}})}},{key:"queryReceiptMessageBySn",value:function(e,t){var n=[e],s=new o.CubeDBReceiptMessage(n);this.dbm.getEntitysByColumns(s,"id",n,function(e,n){e?t(e):n&&n.length>0?t(!1,n[0]):t(!1,null)})}},{key:"storageOffline",value:function(e,t,n){var s=this,i=this;if(!this.dbm)return this.startup(),this.storageOffline(e,t),void setTimeout(function(){s.shutdown()},500);this.querySyncMessage(function(s,r){var o=r[0];for(var u in o)u==e&&(o[e]=t);var l=new a.CubeDBSyncMessage(o.name,o.name,o.Messages,o.syncTimestamp,o.offline,o.offlineAll);i.dbm.setEntity(l,function(e){"function"==typeof n&&n(e)})})}},{key:"querySyncMessage",value:function(e){var t=this;if(!this.dbm)return this.startup(),this.querySyncMessage(e),void setTimeout(function(){t.shutdown()},500);var n=new a.CubeDBSyncMessage;this.dbm.getEntitysByColumn(n,"name",this.engine.accName,function(t,n){t?e(t):n?e(!1,n):e(!1,null)})}},{key:"queryReceiptMessage",value:function(e){var t=this;if(!this.dbm)return this.startup(),this.queryReceiptMessage(e),void setTimeout(function(){t.shutdown()},500);var n=new o.CubeDBReceiptMessage;this.dbm.getAllEntity(n,function(t,n){t?e(t):n?e(!1,n):e(!1,null)})}},{key:"queryMessageBySns",value:function(e,t){var n=this,s=new r.CubeDBMessage(e);this.dbm.getEntitysByColumns(s,"id",e,function(e,s){if(e)t(e);else if(s&&s.length>0){for(var i=[],r=0;r<s.length;++r)n._parseMessage(s[r])&&i.push(n._parseMessage(s[r]));t(!1,i,s)}else t(!1,null)})}},{key:"queryAllMessage",value:function(e){var t=this,n=new r.CubeDBMessage;this.dbm.getAllEntity(n,function(n,s){if(n)e(n);else if(s){for(var i=[],r=0;r<s.length;++r)t._parseMessage(s[r])&&i.push(t._parseMessage(s[r]));e(!1,i)}else e(!1,null)})}},{key:"queryMessageByColumn",value:function(e,t,n){var s=this,i=new r.CubeDBMessage;this.dbm.getEntitysByColumn(i,e,t,function(e,t){if(e)n(e);else if(t){for(var i=[],r=0;r<t.length;++r)s._parseMessage(t[r])&&i.push(s._parseMessage(t[r]));n(!1,i)}else n(!1,null)})}},{key:"queryMessageByManyColumn",value:function(e,t,n){var s=this,i=new r.CubeDBMessage;this.dbm.getEntitysByManyColumn(i,e,t,function(e,t){if(e)n(e);else if(t){for(var i=[],r=0;r<t.length;++r)s._parseMessage(t[r])&&i.push(s._parseMessage(t[r]));n(!1,i)}else n(!1,null)})}},{key:"delMessageBySn",value:function(e,t){var n=[e],s=new r.CubeDBMessage(n);this.dbm.delEntitysByColumn(s,"id",n,function(e){t(e)})}},{key:"delReceiptMessageBySn",value:function(e,t){var n=[e],s=new o.CubeDBReceiptMessage(n);this.dbm.delEntitysByColumn(s,"id",n,function(e){t(e)})}},{key:"getMessageByColumGT",value:function(e,t,n,s){var i=this,a=new r.CubeDBMessage;this.dbm.getEntityByColumnGT(a,e,t,n,function(e,t){if(e)s(e);else if(t){for(var n=[],r=0;r<t.length;++r)i._parseMessage(t[r])&&n.push(i._parseMessage(t[r]));s(!1,n,t)}else s(!1,null)})}},{key:"_parseMessage",value:function(e){var t=void 0;if(void 0==e)return!1;var n=e.receiver?JSON.parse(e.receiver):null,s=JSON.parse(e.sender),i=e.groupInfo?JSON.parse(e.groupInfo):null,r=JSON.parse(e.json);if(e.type===u.MessageType.Text)t=new c.TextMessage(n.name,r.content);else if(e.type===u.MessageType.File)t=new f.FileMessage(n.name),t.file=r.file;else if(e.type===u.MessageType.Image)t=new d.ImageMessage(n.name),t.file=r.file;else if(e.type===u.MessageType.Voice)t=new g.VoiceMessage(n.name),t.file=r.file;else if(e.type===u.MessageType.Video)t=new y.VideoMessage(n.name),t.file=r.file;else if(e.type===u.MessageType.Whiteboard)t=new p.WhiteboardMessage(n.name),t.file=r.file;else if(e.type===u.MessageType.Card)t=new h.CardMessage(n.name,r.title,r.icon,r.content),t.file=r.file,t.cardContents=r.cardContents,t.url=r.url;else if(e.type===u.MessageType.Custom){if(t=new v.CustomMessage(n.name),void 0!==r.header)for(var a in r.header)t.setHeader(a,r.header[a]);void 0!==r.body&&t.setBody(r.body)}else e.type===u.MessageType.Reply?t=new m.ReplyMessage(n.name,r.reply,r.source):e.type===u.MessageType.Receipt&&(t=new b.ReceiptMessage);return t?(t.sn=e.sn,t.sender=s,t.receiver=n,null!==i&&(t.group=i,t.groupName=i.name),t.sendTime=r.time.send,t.receiveTime=r.time.receive,t.timestamp=r.time.timestamp,t.traceless=r.traceless,t.status=e.status,t.fromDevice=e.fromDevice?JSON.parse(e.fromDevice):"",t.receivedDevices=e.receivedDevices?JSON.parse(e.receivedDevices):"",t.direction=this.engine.accName===t.sender?l.MessageDirection.Sent:l.MessageDirection.Received,t.receipted=1===e.receipted,t.anonymous=!!r.anonymous,t.fileStatus&&(t.fileStatus=r.fileStatus),t):void 0}}]),e}()},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});t.CubeDBMessage=function(e){function t(e,n,r,a,o,u,l,c,f,p,d,g,y){s(this,t);var h=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"CubeDBMessage"));return h.sn=n,h.sender=r,h.receiver=a,h.groupInfo=o,h.type=u,h.sendTimestamp=l,h.status=c,h.fromDevice=f,h.receivedDevices=p,h.json=y,h.receipted=d,h.anonymous=g,h}return r(t,e),t}(CubeDBEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});t.CubeDBReceiptMessage=function(e){function t(e,n,r){s(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"CubeDBReceiptMessage"));return a.message=n,a.name=r,a}return r(t,e),t}(CubeDBEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});t.CubeDBSyncMessage=function(e){function t(e,n,r,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];s(this,t);var l=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"CubeDBSyncMessage"));return l.Messages=r,l.name=n,l.syncTimestamp=a,l.offline=o,l.offlineAll=u,l}return r(t,e),t}(CubeDBEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();t.MessageQueue=function(){function e(t,n){s(this,e),this.list=[],this.fileList=[],this.timeout=18e4,this.tick=null,this.delegate=n,this.worker=t}return i(e,[{key:"read",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=0;n<this.list.length;n++){var s=this.list[n];if(s.sn===e)return t&&this.list.splice(n,1),s}var i=!0,r=!1,a=void 0;try{for(var o,u=this.fileList[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var l=o.value;if(l.sn===e)return l}}catch(e){r=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(r)throw a}}return null}},{key:"enqueue",value:function(e){var t=this;if(e._notifyAck)this.fileList.push(e);else{var n=e.sn;this.list.push(e),this.list.length<=1&&(this.tick=setTimeout(function(){t.check(n)},this.timeout))}}},{key:"dequeue",value:function(e){this.read(e,!0),0===this.list.length&&clearTimeout(this.tick)}},{key:"check",value:function(e){var t=this,n=this.read(e,!0);if(n&&this.delegate.onMessageFailed(CubeStateCode.RequestTimeout,n),this.list.length>0){var s=this.list[0],i=this.timeout-(Date.now()-s.sendTime);this.tick=setTimeout(function(){t.check(s.sn)},i>0?i:0)}}}]),e}()},function(e,t,n){"use strict";var s,i,r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(a){if("object"===r(t))e.exports=a();else{s=a,void 0!==(i="function"==typeof s?s.call(t,n,t,e):s)&&(e.exports=i)}}(function(e){function t(e,t){var n=e[0],s=e[1],i=e[2],r=e[3];n+=(s&i|~s&r)+t[0]-680876936|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[1]-389564586|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[2]+606105819|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[3]-1044525330|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[4]-176418897|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[5]+1200080426|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[6]-1473231341|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[7]-45705983|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[8]+1770035416|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[9]-1958414417|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[10]-42063|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[11]-1990404162|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[12]+1804603682|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[13]-40341101|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[14]-1502002290|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[15]+1236535329|0,s=(s<<22|s>>>10)+i|0,n+=(s&r|i&~r)+t[1]-165796510|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[6]-1069501632|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[11]+643717713|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[0]-373897302|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[5]-701558691|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[10]+38016083|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[15]-660478335|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[4]-405537848|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[9]+568446438|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[14]-1019803690|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[3]-187363961|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[8]+1163531501|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[13]-1444681467|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[2]-51403784|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[7]+1735328473|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[12]-1926607734|0,s=(s<<20|s>>>12)+i|0,n+=(s^i^r)+t[5]-378558|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[8]-2022574463|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[11]+1839030562|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[14]-35309556|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[1]-1530992060|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[4]+1272893353|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[7]-155497632|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[10]-1094730640|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[13]+681279174|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[0]-358537222|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[3]-722521979|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[6]+76029189|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[9]-640364487|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[12]-421815835|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[15]+530742520|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[2]-995338651|0,s=(s<<23|s>>>9)+i|0,n+=(i^(s|~r))+t[0]-198630844|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[7]+1126891415|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[14]-1416354905|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[5]-57434055|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[12]+1700485571|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[3]-1894986606|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[10]-1051523|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[1]-2054922799|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[8]+1873313359|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[15]-30611744|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[6]-1560198380|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[13]+1309151649|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[4]-145523070|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[11]-1120210379|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[2]+718787259|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[9]-343485551|0,s=(s<<21|s>>>11)+i|0,e[0]=n+e[0]|0,e[1]=s+e[1]|0,e[2]=i+e[2]|0,e[3]=r+e[3]|0}function n(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function s(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function i(e){var s,i,r,a,o,u,l=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(s=64;s<=l;s+=64)t(c,n(e.substring(s-64,s)));for(e=e.substring(s-64),i=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=0;s<i;s+=1)r[s>>2]|=e.charCodeAt(s)<<(s%4<<3);if(r[s>>2]|=128<<(s%4<<3),s>55)for(t(c,r),s=0;s<16;s+=1)r[s]=0;return a=8*l,a=a.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(a[2],16),u=parseInt(a[1],16)||0,r[14]=o,r[15]=u,t(c,r),c}function r(e){var n,i,r,a,o,u,l=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(n=64;n<=l;n+=64)t(c,s(e.subarray(n-64,n)));for(e=n-64<l?e.subarray(n-64):new Uint8Array(0),i=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=0;n<i;n+=1)r[n>>2]|=e[n]<<(n%4<<3);if(r[n>>2]|=128<<(n%4<<3),n>55)for(t(c,r),n=0;n<16;n+=1)r[n]=0;return a=8*l,a=a.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(a[2],16),u=parseInt(a[1],16)||0,r[14]=o,r[15]=u,t(c,r),c}function a(e){var t,n="";for(t=0;t<4;t+=1)n+=g[e>>8*t+4&15]+g[e>>8*t&15];return n}function o(e){var t;for(t=0;t<e.length;t+=1)e[t]=a(e[t]);return e.join("")}function u(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function l(e,t){var n,s=e.length,i=new ArrayBuffer(s),r=new Uint8Array(i);for(n=0;n<s;n+=1)r[n]=e.charCodeAt(n);return t?r:i}function c(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function f(e,t,n){var s=new Uint8Array(e.byteLength+t.byteLength);return s.set(new Uint8Array(e)),s.set(new Uint8Array(t),e.byteLength),n?s:s.buffer}function p(e){var t,n=[],s=e.length;for(t=0;t<s-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function d(){this.reset()}var g=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return"5d41402abc4b2a76b9719d911017c592"!==o(i("hello"))&&function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function t(e,t){return e=0|e||0,e<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,s){var i,r,a,o,u=this.byteLength,l=t(n,u),c=u;return s!==e&&(c=t(s,u)),l>c?new ArrayBuffer(0):(i=c-l,r=new ArrayBuffer(i),a=new Uint8Array(r),o=new Uint8Array(this,l,i),a.set(o),r)}}(),d.prototype.append=function(e){return this.appendBinary(u(e)),this},d.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var s,i=this._buff.length;for(s=64;s<=i;s+=64)t(this._hash,n(this._buff.substring(s-64,s)));return this._buff=this._buff.substring(s-64),this},d.prototype.end=function(e){var t,n,s=this._buff,i=s.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)r[t>>2]|=s.charCodeAt(t)<<(t%4<<3);return this._finish(r,i),n=o(this._hash),e&&(n=p(n)),this.reset(),n},d.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},d.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},d.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},d.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},d.prototype._finish=function(e,n){var s,i,r,a=n;if(e[a>>2]|=128<<(a%4<<3),a>55)for(t(this._hash,e),a=0;a<16;a+=1)e[a]=0;s=8*this._length,s=s.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(s[2],16),r=parseInt(s[1],16)||0,e[14]=i,e[15]=r,t(this._hash,e)},d.hash=function(e,t){return d.hashBinary(u(e),t)},d.hashBinary=function(e,t){var n=i(e),s=o(n);return t?p(s):s},d.ArrayBuffer=function(){this.reset()},d.ArrayBuffer.prototype.append=function(e){var n,i=f(this._buff.buffer,e,!0),r=i.length;for(this._length+=e.byteLength,n=64;n<=r;n+=64)t(this._hash,s(i.subarray(n-64,n)));return this._buff=n-64<r?new Uint8Array(i.buffer.slice(n-64)):new Uint8Array(0),this},d.ArrayBuffer.prototype.end=function(e){var t,n,s=this._buff,i=s.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)r[t>>2]|=s[t]<<(t%4<<3);return this._finish(r,i),n=o(this._hash),e&&(n=p(n)),this.reset(),n},d.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},d.ArrayBuffer.prototype.getState=function(){var e=d.prototype.getState.call(this);return e.buff=c(e.buff),e},d.ArrayBuffer.prototype.setState=function(e){return e.buff=l(e.buff,!0),d.prototype.setState.call(this,e)},d.ArrayBuffer.prototype.destroy=d.prototype.destroy,d.ArrayBuffer.prototype._finish=d.prototype._finish,d.ArrayBuffer.hash=function(e,t){var n=r(new Uint8Array(e)),s=o(n);return t?p(s):s},d})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageAction={MessageSync:"/v3/message/sync"}}]);
//# sourceMappingURL=cube-message.js.map